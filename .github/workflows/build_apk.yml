name: Build ColorSense APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build Release APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter 3.19.0
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true

      - name: Fix Android gradle files
        run: |
          cat > android/gradle.properties << 'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=512m
          org.gradle.daemon=true
          org.gradle.parallel=true
          EOF

          mkdir -p android/gradle/wrapper
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-all.zip
          EOF

          cat > android/settings.gradle << 'EOF'
          include ':app'
          def localPropertiesFile = new File(rootProject.projectDir, "local.properties")
          def properties = new Properties()
          assert localPropertiesFile.exists()
          localPropertiesFile.withReader("UTF-8") { reader -> properties.load(reader) }
          def flutterSdkPath = properties.getProperty("flutter.sdk")
          assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
          apply from: "$flutterSdkPath/packages/flutter_tools/gradle/app_plugin_loader.gradle"
          EOF

      - name: Fix app/build.gradle
        run: |
          cat > android/app/build.gradle << 'EOF'
          def localProperties = new Properties()
          def localPropertiesFile = rootProject.file('local.properties')
          if (localPropertiesFile.exists()) {
              localPropertiesFile.withReader('UTF-8') { reader -> localProperties.load(reader) }
          }
          def flutterRoot = localProperties.getProperty('flutter.sdk')
          if (flutterRoot == null) {
              throw new GradleException("Flutter SDK not found.")
          }
          def flutterVersionCode = localProperties.getProperty('flutter.versionCode') ?: '1'
          def flutterVersionName = localProperties.getProperty('flutter.versionName') ?: '1.0'

          apply plugin: 'com.android.application'
          apply from: "$flutterRoot/packages/flutter_tools/gradle/flutter.gradle"

          android {
              namespace 'com.example.colorsense'
              compileSdkVersion 34
              ndkVersion flutter.ndkVersion
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
              defaultConfig {
                  applicationId 'com.example.colorsense'
                  minSdkVersion 26
                  targetSdkVersion 34
                  versionCode flutterVersionCode.toInteger()
                  versionName flutterVersionName
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled false
                      shrinkResources false
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
              packagingOptions {
                  pickFirst '**/libtensorflowlite_jni.so'
                  pickFirst '**/libtensorflowlite_gpu_jni.so'
              }
              aaptOptions {
                  noCompress 'tflite'
                  noCompress 'lite'
              }
          }

          flutter { source '../..' }

          dependencies {
              implementation 'org.tensorflow:tensorflow-lite-gpu:2.14.0'
              implementation 'org.tensorflow:tensorflow-lite-gpu-delegate-plugin:0.4.4'
          }
          EOF

      - name: Create Android resources and icons
        run: |
          mkdir -p android/app/src/main/res/{drawable,drawable-v21,values,values-night}
          mkdir -p android/app/src/main/res/mipmap-{mdpi,hdpi,xhdpi,xxhdpi,xxxhdpi}
          mkdir -p android/app/src/main/kotlin/com/example/colorsense

          cat > android/app/src/main/res/drawable/launch_background.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <layer-list xmlns:android="http://schemas.android.com/apk/res/android">
              <item android:drawable="@android:color/black" />
          </layer-list>
          EOF

          cp android/app/src/main/res/drawable/launch_background.xml android/app/src/main/res/drawable-v21/launch_background.xml

          cat > android/app/src/main/res/values/styles.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <style name="LaunchTheme" parent="@android:style/Theme.Black.NoTitleBar">
                  <item name="android:windowBackground">@drawable/launch_background</item>
              </style>
              <style name="NormalTheme" parent="@android:style/Theme.Black.NoTitleBar">
                  <item name="android:windowBackground">@android:color/black</item>
              </style>
          </resources>
          EOF

          cp android/app/src/main/res/values/styles.xml android/app/src/main/res/values-night/styles.xml

          cat > android/app/src/main/kotlin/com/example/colorsense/MainActivity.kt << 'EOF'
          package com.example.colorsense
          import io.flutter.embedding.android.FlutterActivity
          class MainActivity: FlutterActivity()
          EOF

          python3 << 'PYEOF'
          import struct, zlib, os

          def make_png(size, r, g, b):
              def chunk(tag, data):
                  raw = tag + data
                  return struct.pack('>I', len(data)) + raw + struct.pack('>I', zlib.crc32(raw) & 0xffffffff)
              sig = b'\x89PNG\r\n\x1a\n'
              ihdr = chunk(b'IHDR', struct.pack('>IIBBBBB', size, size, 8, 2, 0, 0, 0))
              rows = b''.join(b'\x00' + bytes([r, g, b] * size) for _ in range(size))
              idat = chunk(b'IDAT', zlib.compress(rows, 9))
              iend = chunk(b'IEND', b'')
              return sig + ihdr + idat + iend

          for d, s in {'mdpi':48,'hdpi':72,'xhdpi':96,'xxhdpi':144,'xxxhdpi':192}.items():
              path = f'android/app/src/main/res/mipmap-{d}/ic_launcher.png'
              with open(path, 'wb') as f:
                  f.write(make_png(s, 0, 229, 255))
              print(f'Icon {d}: {s}x{s}')
          PYEOF

      - name: Create TFLite model stubs
        run: |
          mkdir -p assets/models
          python3 << 'PYEOF'
          import struct, zlib, os
          # Minimal TFLite stub - app has fallback detection when model is invalid
          stub = b'\x14\x00\x00\x00TFL3' + b'\x00' * 40
          for m in ['yolov9_tiny.tflite', 'ddcolor.tflite']:
              path = f'assets/models/{m}'
              if not os.path.exists(path) or os.path.getsize(path) < 10:
                  with open(path, 'wb') as f:
                      f.write(stub)
                  print(f'Stub created: {path}')
          PYEOF

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze (non-blocking)
        run: flutter analyze --no-fatal-infos || true

      - name: Build APK
        run: flutter build apk --release --split-per-abi

      - name: Build Universal APK
        run: flutter build apk --release

      - name: Show APK sizes
        run: find build/app/outputs -name "*.apk" -exec ls -lh {} \;

      - name: Upload ARM64 APK (best for modern phones)
        uses: actions/upload-artifact@v4
        with:
          name: ColorSense-arm64
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          retention-days: 30

      - name: Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: ColorSense-universal
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
